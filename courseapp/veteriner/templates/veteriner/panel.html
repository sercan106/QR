{% load static %}
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>Veteriner Paneli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-3">

  <div class="container">
    <!-- Üst Başlık -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-0">Merhaba, {{ vet.ad|default:request.user.username }}</h3>
      <a href="{% url 'veteriner:veteriner_profil_tamamla' %}" class="btn btn-outline-secondary btn-sm">
        Profili Düzenle
      </a>
    </div>

    <!-- Özet Kartları -->
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body text-center">
            <h6 class="card-title">Tahsis Sayısı</h6>
            <p class="display-6 mb-0">{{ tahsis_sayisi }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body text-center">
            <h6 class="card-title">Satış Sayısı</h6>
            <p class="display-6 mb-0">{{ satis_sayisi }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body text-center">
            <h6 class="card-title">Kalan Envanter</h6>
            <p class="display-6 mb-0">{{ kalan_envanter }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Yeni Sipariş Butonu -->
    <div class="row g-3 mb-4">
      <div class="col-12 text-center">
        <button type="button" class="btn btn-lg btn-primary" data-bs-toggle="modal" data-bs-target="#siparisModal">
          Yeni Sipariş Talebi Oluştur
        </button>
      </div>
    </div>

    <!-- Son Tahsis / Satış Listeleri -->
    <div class="row g-3 mb-4">
      <div class="col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Son Tahsis Edilen Etiketler</strong>
            <a href="{% url 'veteriner:tahsis_listesi' %}" class="btn btn-sm btn-link">Hepsini Gör</a>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table mb-0 table-sm table-striped">
                <thead>
                  <tr>
                    <th>Seri No</th>
                    <th>Tahsis Tarihi</th>
                    <th>Durum</th>
                  </tr>
                </thead>
                <tbody>
                {% for e in tahsis_edilenler %}
                  <tr>
                    <td>{{ e.seri_numarasi }}</td>
                    <td>{{ e.tahsis_tarihi|date:"d.m.Y" }}</td>
                    <td>
                      {% if e.aktif %}
                        <span class="badge bg-success">Aktif</span>
                      {% else %}
                        <span class="badge bg-warning text-dark">Pasif</span>
                      {% endif %}
                    </td>
                  </tr>
                {% empty %}
                  <tr><td colspan="3" class="text-muted p-3">Tahsis edilmiş etiket yok.</td></tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Satılan / Aktive Edilen Etiketler</strong>
            <a href="{% url 'veteriner:satis_listesi' %}" class="btn btn-sm btn-link">Hepsini Gör</a>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table mb-0 table-sm table-striped">
                <thead>
                  <tr>
                    <th>Seri No</th>
                    <th>İlk Aktivasyon</th>
                    <th>Son Aktifleşme</th>
                  </tr>
                </thead>
                <tbody>
                {% for e in satilanlar %}
                  <tr>
                    <td>{{ e.seri_numarasi }}</td>
                    <td>{{ e.first_activated_at|date:"d.m.Y H:i" }}</td>
                    <td>{{ e.aktiflestirme_tarihi|date:"d.m.Y H:i" }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="3" class="text-muted p-3">Kayıt yok.</td></tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Son Siparişler -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Sipariş Taleplerim</strong>
            <a href="{% url 'veteriner:siparis_listesi' %}" class="btn btn-sm btn-link">Hepsini Gör</a>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table mb-0 table-sm table-striped">
                <thead>
                  <tr>
                    <th>Talep Edilen Adet</th>
                    <th>Talep Tarihi</th>
                    <th>Durum</th>
                    <th>Adres</th>
                  </tr>
                </thead>
                <tbody>
                {% for s in siparis_istekleri %}
                  <tr>
                    <td>{{ s.talep_edilen_adet }}</td>
                    <td>{{ s.talep_tarihi|date:"d.m.Y" }}</td>
                    <td>
                      {% if s.onaylandi %}
                        <span class="badge bg-success">Onaylandı</span>
                      {% else %}
                        <span class="badge bg-warning text-dark">Beklemede</span>
                      {% endif %}
                      {% if s.kargolandimi %}
                        <span class="badge bg-primary ms-1">Kargolandı</span>
                      {% endif %}
                      {% if s.numune_mi %}
                        <span class="badge bg-info text-dark ms-1">Numune</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if s.farkli_adres_kullan %}
                        <span class="badge bg-info text-dark">Farklı Adres</span>
                      {% else %}
                        <span class="badge bg-secondary">Kayıtlı Adres</span>
                      {% endif %}
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="4" class="text-muted p-3">Henüz sipariş talebiniz bulunmamaktadır.</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mesajlar -->
    {% if messages %}
      <div class="mt-3">
        {% for m in messages %}
          <div class="alert alert-{{ m.tags|default:'info' }} mb-2">{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <!-- Sipariş Modal -->
  <div class="modal fade" id="siparisModal" tabindex="-1" aria-labelledby="siparisModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="siparisModalLabel">Yeni Etiket Siparişi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>

        <form method="post" novalidate>
          {% csrf_token %}
          <div class="modal-body">
            <!-- Adet -->
            <div class="mb-3">
              <label for="{{ siparis_form.talep_edilen_adet.id_for_label }}" class="form-label">
                Talep Edilen Etiket Adeti
              </label>
              {{ siparis_form.talep_edilen_adet }}
              <div class="form-text">Minimum 5 adet.</div>
              {% if siparis_form.talep_edilen_adet.errors %}
                <div class="text-danger small mt-1">{{ siparis_form.talep_edilen_adet.errors }}</div>
              {% endif %}
            </div>

            <hr>

            <!-- Kayıtlı adres -->
            <div class="alert alert-secondary">
              <h6 class="alert-heading">Kayıtlı Adresiniz</h6>
              <p class="mb-0">{{ vet.adres_detay }}<br>{{ vet.ilce }}, {{ vet.il }}</p>
            </div>

            <!-- Farklı adrese gönder -->
            <div class="form-check mb-3">
              {{ siparis_form.farkli_adres_kullan }}
              <label class="form-check-label" for="{{ siparis_form.farkli_adres_kullan.id_for_label }}">
                Farklı bir adrese gönder
              </label>
            </div>

            <div id="yeni-adres-alanlari" style="display: none;">
              <h6 class="mb-3">Yeni Adres Bilgileri</h6>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="{{ siparis_form.il.id_for_label }}" class="form-label">İl</label>
                  {{ siparis_form.il }}
                  {% if siparis_form.il.errors %}<div class="text-danger small mt-1">{{ siparis_form.il.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                  <label for="{{ siparis_form.ilce.id_for_label }}" class="form-label">İlçe</label>
                  {{ siparis_form.ilce }}
                  {% if siparis_form.ilce.errors %}<div class="text-danger small mt-1">{{ siparis_form.ilce.errors }}</div>{% endif %}
                </div>
              </div>
              <div class="mb-3">
                <label for="{{ siparis_form.adres_detay.id_for_label }}" class="form-label">Adres Detay</label>
                {{ siparis_form.adres_detay }}
                {% if siparis_form.adres_detay.errors %}<div class="text-danger small mt-1">{{ siparis_form.adres_detay.errors }}</div>{% endif %}
              </div>
            </div>

            <hr>

            <!-- Numune talebi -->
            <div class="form-check mb-3">
              {{ siparis_form.numune_mi }}
              <label class="form-check-label" for="{{ siparis_form.numune_mi.id_for_label }}">
                Numune (Ücretsiz) Talebi
              </label>
              <div class="form-text">Numune isteği admin tarafından onaylanır.</div>
            </div>

            <div class="alert alert-info small">
              Ödeme ve kargo işlemleri <strong>admin</strong> tarafından yapılır ve burada görüntülenir.
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
            <button type="submit" class="btn btn-primary">Siparişi Gönder</button>
          </div>
        </form>

      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('siparisModal');
      const farkliAdresCheckbox = document.getElementById('id_farkli_adres_kullan');
      const yeniAdresAlanlari = document.getElementById('yeni-adres-alanlari');

      function toggleYeniAdresAlanlari() {
        yeniAdresAlanlari.style.display = farkliAdresCheckbox.checked ? 'block' : 'none';
      }
      if (farkliAdresCheckbox) {
        farkliAdresCheckbox.addEventListener('change', toggleYeniAdresAlanlari);
        toggleYeniAdresAlanlari();
      }

      // Form hatalıysa modal'ı otomatik aç
      {% if siparis_form.errors %}
        const myModal = new bootstrap.Modal(modal);
        myModal.show();
        // Adres hatası varsa alanları göster
        {% if siparis_form.il.errors or siparis_form.ilce.errors or siparis_form.adres_detay.errors %}
          if (farkliAdresCheckbox) {
            farkliAdresCheckbox.checked = true;
            toggleYeniAdresAlanlari();
          }
        {% endif %}
      {% endif %}
    });
  </script>

</body>
</html>
