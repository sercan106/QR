{% extends 'ana.html' %}
{% load static %}

{% block css_dosyalar %}
<style>
    .cart-table th, .cart-table td { text-align: center; vertical-align: middle; }
    .quantity-form { display: inline-flex; align-items: center; }
    .quantity-form input { width: 60px; text-align: center; border-radius: 0; }
    .quantity-form .btn { padding: 0.375rem 0.75rem; }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <h2 class="text-center mb-5 fw-bold text-primary" data-aos="fade-down">Sepetiniz</h2>

    {% if messages %}
    <div class="toast-container position-fixed top-0 end-0 p-3">
        {% for message in messages %}
        <div class="toast align-items-center text-bg-{% if message.tags == 'success' %}success{% elif message.tags == 'warning' %}warning{% else %}info{% endif %} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    {{ message }}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
        {% endfor %}
    </div>
    <script>
        document.querySelectorAll('.toast').forEach(toast => new bootstrap.Toast(toast).show());
    </script>
    {% endif %}

    {% if urunler %}
    <table class="table table-bordered table-hover cart-table shadow-lg">
        <thead class="table-light">
            <tr>
                <th>Ürün</th>
                <th>Fiyat</th>
                <th>Miktar</th>
                <th>Ara Toplam</th>
                <th>İşlem</th>
            </tr>
        </thead>
        <tbody>
            {% for item in urunler %}
            <tr data-aos="fade-up">
                <td>{{ item.urun.ad }}</td>
                <td>{{ item.urun.fiyat }} TL</td>
                <td>
                    <form action="{% url 'update_cart_quantity' item.urun.pk %}" method="post" class="quantity-form">
                        {% csrf_token %}
                        <button type="button" class="btn btn-sm btn-secondary minus-btn">-</button>
                        <input type="number" name="miktar" value="{{ item.miktar }}" min="1" max="{{ item.urun.stok }}" class="form-control quantity-input" readonly>
                        <button type="button" class="btn btn-sm btn-secondary plus-btn">+</button>
                        <button type="submit" class="btn btn-sm btn-secondary d-none update-btn">Güncelle</button> <!-- Gizli submit butonu -->
                    </form>
                </td>
                <td>{{ item.subtotal }} TL</td>
                <td>
                    <a href="{% url 'remove_from_cart' item.urun.pk %}" class="btn btn-sm btn-danger">Kaldır</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3" class="fw-bold text-end">Toplam:</td>
                <td colspan="2" class="fw-bold text-primary">{{ toplam }} TL</td>
            </tr>
        </tfoot>
    </table>
    <div class="text-end mt-4">
        <a href="{% url 'checkout' %}" class="btn btn-primary rounded-pill px-5">Ödemeye Geç</a>
    </div>
    {% else %}
    <p class="text-center alert alert-info">Sepetiniz boş. Alışverişe devam edin!</p>
    {% endif %}
</div>
{% endblock %}

{% block js_dosyalar %}
<script>
    document.querySelectorAll('.minus-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const input = btn.nextElementSibling;
            let value = parseInt(input.value);
            if (value > parseInt(input.min)) {
                input.value = value - 1;
                btn.parentElement.querySelector('.update-btn').click();  // Form submit et
            }
        });
    });

    document.querySelectorAll('.plus-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const input = btn.previousElementSibling;
            let value = parseInt(input.value);
            if (value < parseInt(input.max)) {
                input.value = value + 1;
                btn.parentElement.querySelector('.update-btn').click();  // Form submit et
            }
        });
    });
</script>
{% endblock %}